<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Watch live football streams, view schedules, and enjoy matches in high quality.">
    <title>Football Live Streams - Premium Experience</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #ff9900;
            --secondary-color: #ffb366;
            --bg-dark: #0f0f0f;
            --bg-medium: #1a1a1a;
            --bg-light: #2a2a2a;
            --text-light: #e0e0e0;
            --text-medium: #cccccc;
            --text-dark: #bbbbbb;
            --shadow: rgba(0, 0, 0, 0.5);
            --accent-green: #00ff66;
            --accent-yellow: #ffcc33;
            --accent-red: #ff6666;
            --accent-blue: #00ccff;
            --schedule-box: #4a4a4a;
        }

        body.light-mode {
            --primary-color: #cc7a00;
            --secondary-color: #ff9933;
            --bg-dark: #ffffff;
            --bg-medium: #f5f5f5;
            --bg-light: #e0e0e0;
            --text-light: #333333;
            --text-medium: #666666;
            --text-dark: #888888;
            --shadow: rgba(0, 0, 0, 0.1);
            --accent-green: #00cc55;
            --accent-yellow: #e6b800;
            --accent-red: #e60000;
            --accent-blue: #0099cc;
            --schedule-box: #d0d0d0;
            background: linear-gradient(180deg, #ffffff, #f5f5f5);
        }

        /* Same CSS as previous version, omitted for brevity */
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(180deg, var(--bg-dark), var(--bg-medium)); color: var(--text-light); display: flex; flex-direction: column; min-height: 100vh; overflow-x: hidden; line-height: 1.6; }
        header { padding: 20px 40px; background: linear-gradient(90deg, var(--bg-medium), var(--bg-light)); display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 12px var(--shadow); position: sticky; top: 0; z-index: 1500; }
        header h1 { font-size: 2.2rem; font-weight: 800; color: var(--primary-color); text-shadow: 0 1px 3px rgba(255, 153, 0, 0.3); display: flex; align-items: center; gap: 10px; }
        header h1 i { font-size: 1.8rem; }
        .nav-tabs { display: flex; gap: 20px; }
        .nav-tab { padding: 12px 24px; border-radius: 12px; cursor: pointer; background: var(--bg-light); transition: all 0.3s ease; font-weight: 600; font-size: 1.1rem; color: var(--text-medium); display: flex; align-items: center; gap: 8px; }
        .nav-tab:hover { background: #444444; transform: scale(1.05); }
        .nav-tab.active { background: var(--primary-color); color: #fff; transform: scale(1.1); box-shadow: 0 2px 6px rgba(255, 153, 0, 0.4); }
        #themeToggle, #settingsBtn { padding: 10px 20px; background: var(--bg-light); border: none; border-radius: 8px; color: var(--text-light); cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: flex; align-items: center; gap: 8px; margin-left: 10px; }
        #themeToggle:hover, #settingsBtn:hover { background: #444444; transform: scale(1.05); }
        #statusBar { padding: 12px 40px; background: #222222; display: flex; justify-content: space-between; align-items: center; font-size: 1rem; border-bottom: 2px solid #3a3a3a; box-shadow: 0 2px 8px var(--shadow); }
        #statusBar .warning { color: var(--accent-yellow); font-weight: 600; display: flex; align-items: center; gap: 8px; }
        #statusBar .status-loading { color: var(--accent-blue); }
        #statusBar .status-active { color: var(--accent-green); }
        #statusBar .status-frozen { color: var(--accent-red); }
        #statusBar .status-not-playing { color: var(--accent-yellow); }
        #timer { font-weight: 700; font-size: 1.2rem; color: var(--text-light); text-shadow: 0 1px 2px var(--shadow); display: flex; align-items: center; gap: 8px; }
        .page { display: none; flex: 1; overflow-y: auto; animation: fadeIn 0.4s ease; padding: 30px 40px; }
        .page.active { display: flex; flex-direction: column; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        #match.active { padding: 0; height: calc(100vh - 80px); }
        #playerContainer { position: relative; width: 100%; height: 100%; display: flex; flex: 1; background: linear-gradient(180deg, #000000, #1a1a1a); overflow: hidden; }
        iframe#playerFrame { width: 100%; height: 100%; border: none; position: absolute; top: 0; left: 0; z-index: 0; }
        #controlPanel { position: absolute; bottom: 20px; left: 20px; background: rgba(0, 0, 0, 0.8); border-radius: 8px; padding: 10px; display: flex; gap: 10px; z-index: 2; }
        .control-btn { background: var(--bg-light); border: none; padding: 8px; border-radius: 50%; color: var(--text-light); cursor: pointer; transition: all 0.3s; font-size: 1rem; }
        .control-btn:hover { background: var(--primary-color); }
        #fullscreenBtn { position: absolute; bottom: 20px; right: 20px; background: rgba(0, 0, 0, 0.7); color: #fff; border: none; padding: 10px; border-radius: 50%; cursor: pointer; z-index: 2; transition: all 0.3s; }
        #fullscreenBtn:hover { background: var(--primary-color); }
        .schedule-controls { display: flex; gap: 15px; margin-bottom: 25px; flex-wrap: wrap; align-items: center; }
        .search-bar { flex: 1; min-width: 200px; position: relative; }
        .search-bar input { width: 100%; padding: 10px 40px 10px 15px; background: var(--bg-light); border: none; border-radius: 8px; color: var(--text-light); font-size: 1rem; transition: box-shadow 0.3s ease; }
        .search-bar input:focus { box-shadow: 0 0 8px var(--primary-color); }
        .search-bar input::placeholder { color: var(--text-medium); }
        .search-bar i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-medium); }
        .control-btn { padding: 10px 20px; background: var(--bg-light); border: none; border-radius: 8px; color: var(--text-light); cursor: pointer; transition: all 0.3s ease; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .control-btn:hover { background: var(--primary-color); color: #fff; transform: translateY(-2px); }
        select { padding: 10px; background: var(--bg-light); border: none; border-radius: 8px; color: var(--text-light); font-size: 1rem; cursor: pointer; transition: all 0.3s ease; }
        select:focus { outline: none; box-shadow: 0 0 8px var(--primary-color); }
        .day-section { margin-bottom: 30px; }
        .day-title { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); margin-bottom: 15px; border-bottom: 2px solid var(--primary-color); padding-bottom: 5px; }
        .schedule-grid { display: grid; gap: 15px; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); }
        .schedule-item { background: linear-gradient(135deg, var(--schedule-box), var(--bg-light)); padding: 15px; border-radius: 10px; cursor: pointer; transition: transform 0.3s ease, box-shadow 0.3s ease; border: 2px solid var(--schedule-box); box-shadow: 0 4px 12px var(--shadow); display: flex; flex-direction: column; gap: 10px; }
        .schedule-item:hover { transform: scale(1.05) rotate(1deg); box-shadow: 0 8px 16px var(--shadow); }
        .schedule-item.live { border-color: var(--accent-green); animation: pulse 2s infinite; }
        .schedule-item.upcoming { border-color: var(--accent-yellow); }
        .schedule-item.finished { border-color: var(--accent-red); }
        .schedule-item.prime-time { box-shadow: 0 0 10px var(--accent-yellow); }
        @keyframes pulse { 0% { border-color: var(--accent-green); } 50% { border-color: rgba(0, 255, 102, 0.5); } 100% { border-color: var(--accent-green); } }
        .match-details { display: flex; flex-direction: column; gap: 6px; }
        .match-details h3 { margin: 0; font-size: 1.4rem; color: var(--primary-color); transition: color 0.3s ease; }
        .schedule-item:hover h3 { color: var(--secondary-color); }
        .match-details p { margin: 0; font-size: 0.9rem; color: var(--text-dark); }
        .match-status { font-size: 0.8rem; font-weight: 700; padding: 5px 12px; border-radius: 15px; text-align: center; margin-top: 8px; width: fit-content; }
        .match-status.live { background: var(--accent-green); color: #000; }
        .match-status.upcoming { background: var(--accent-yellow); color: #000; }
        .match-status.finished { background: var(--accent-red); color: #fff; }
        .stream-count { padding: 8px 15px; background: var(--bg-light); border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: 600; color: var(--text-medium); }
        .stream-list { display: grid; gap: 20px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); margin-top: 20px; }
        .stream-item { padding: 15px; background: var(--bg-light); border-radius: 12px; cursor: pointer; transition: all 0.3s ease; border: 2px solid var(--bg-medium); text-align: center; font-weight: 600; font-size: 1.1rem; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 12px var(--shadow); gap: 10px; }
        .stream-item:hover { background: var(--primary-color); color: #fff; transform: scale(1.1) translateY(-5px); box-shadow: 0 8px 16px var(--shadow); }
        .stream-item i { font-size: 1.5rem; color: var(--primary-color); }
        .stream-item:hover i { color: #fff; }
        .stream-quality { font-size: 0.8rem; padding: 4px 8px; border-radius: 10px; margin-top: 5px; }
        .stream-quality.hd { background: var(--accent-green); color: #000; }
        .stream-quality.sd { background: var(--accent-yellow); color: #000; }
        #streamMatchTitle { font-size: 2.5rem; font-weight: 800; color: var(--primary-color); margin-bottom: 30px; text-align: center; text-shadow: 0 2px 4px var(--shadow); }
        #loadingSpinner { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border: 12px solid var(--bg-light); border-top: 12px solid var(--primary-color); border-radius: 50%; width: 80px; height: 80px; animation: spin 1s linear infinite; z-index: 2000; }
        @keyframes spin { 0% { transform: translate(-50%, -50%) rotate(0deg); } 100% { transform: translate(-50%, -50%) rotate(360deg); } }
        #settingsModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 2000; justify-content: center; align-items: center; }
        #settingsModal .modal-content { background: var(--bg-medium); padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; color: var(--text-light); }
        #settingsModal h2 { font-size: 1.8rem; margin-bottom: 20px; color: var(--primary-color); }
        #settingsModal label { display: block; margin: 10px 0 5px; font-weight: 600; }
        #settingsModal select, #settingsModal input[type="checkbox"] { width: 100%; padding: 10px; margin-bottom: 15px; background: var(--bg-light); border: none; border-radius: 8px; color: var(--text-light); }
        #settingsModal button { padding: 10px 20px; background: var(--primary-color); border: none; border-radius: 8px; color: #fff; cursor: pointer; transition: all 0.3s ease; }
        #settingsModal button:hover { background: var(--secondary-color); }
        footer { padding: 15px 40px; background: var(--bg-medium); text-align: center; color: var(--text-medium); font-size: 0.9rem; border-top: 1px solid var(--bg-light); }
        @media (max-width: 1024px) { .schedule-grid { grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); } }
        @media (max-width: 768px) {
            header { padding: 15px 20px; flex-direction: column; gap: 10px; }
            .nav-tabs { gap: 10px; justify-content: center; }
            .nav-tab { font-size: 1rem; padding: 8px 15px; }
            #statusBar { padding: 10px 20px; flex-direction: column; gap: 10px; }
            .page { padding: 20px; }
            .schedule-grid { grid-template-columns: 1fr; }
            .stream-list { grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); }
            #streamMatchTitle { font-size: 2rem; }
        }
        @media (max-width: 480px) {
            header h1 { font-size: 1.8rem; }
            .control-btn { padding: 8px 15px; font-size: 0.9rem; }
            .search-bar input { font-size: 0.9rem; }
        }
        .teams-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .team { display: flex; align-items: center; gap: 10px; }
        .team-badge { width: auto; height: 40px; object-fit: contain; }
        .vs { font-weight: bold; color: var(--primary-color); }
        .error-message { text-align: center; color: var(--accent-red); font-weight: 600; padding: 20px; background: var(--bg-light); border-radius: 8px; }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-futbol"></i> Football Live Streams</h1>
        <div class="nav-tabs" id="navTabs">
            <div class="nav-tab active" data-page="schedule"><i class="fas fa-calendar-alt"></i> Schedule</div>
            <div class="nav-tab" data-page="streams"><i class="fas fa-stream"></i> Streams</div>
            <div class="nav-tab" data-page="match"><i class="fas fa-tv"></i> Match</div>
        </div>
        <button id="themeToggle"><i class="fas fa-moon"></i> Toggle Theme</button>
        <button id="settingsBtn"><i class="fas fa-cog"></i> Settings</button>
    </header>
    <div id="statusBar">
        <div class="warning" id="streamStatus"><i class="fas fa-exclamation-triangle"></i> Stream may experience interruptions</div>
        <div id="timer"><i class="fas fa-clock"></i> Match Timer: 00:00</div>
    </div>
    <div id="schedule" class="page active">
        <div class="schedule-controls">
            <div class="search-bar">
                <input type="text" id="searchInput" placeholder="Search matches..." oninput="searchMatches()" aria-label="Search matches">
                <i class="fas fa-search"></i>
            </div>
            <select id="timezoneSelect" onchange="updateTimezone()" aria-label="Select time zone">
                <option value="UTC">UTC</option>
                <option value="America/New_York">America/New York</option>
                <option value="Europe/London">Europe/London</option>
                <option value="Asia/Tokyo">Asia/Tokyo</option>
                <option value="Australia/Sydney">Australia/Sydney</option>
            </select>
            <select id="regionSelect" onchange="fetchMatches()" aria-label="Select region">
                <option value="global">Global</option>
                <option value="us">United States</option>
                <option value="uk">United Kingdom</option>
                <option value="eu">Europe</option>
                <option value="asia">Asia</option>
            </select>
            <button class="control-btn" onclick="sortByTime()"><i class="fas fa-sort-amount-up"></i> Sort by Time</button>
            <button class="control-btn" onclick="filterByStatus('upcoming')"><i class="fas fa-hourglass-start"></i> Upcoming</button>
            <button class="control-btn" onclick="filterByStatus('live')"><i class="fas fa-broadcast-tower"></i> Live</button>
            <button class="control-btn" onclick="filterByStatus('finished')"><i class="fas fa-check-circle"></i> Finished</button>
            <button class="control-btn" onclick="filterByStatus('all')"><i class="fas fa-list"></i> All</button>
        </div>
        <div id="scheduleContainer"></div>
    </div>
    <div id="streams" class="page">
        <h2 id="streamMatchTitle"></h2>
        <div id="streamCount" class="stream-count"></div>
        <div class="stream-list" id="streamList"></div>
    </div>
    <div id="match" class="page">
        <div id="playerContainer">
            <iframe id="playerFrame" src="" allowfullscreen allow="encrypted-media; picture-in-picture; fullscreen"></iframe>
            <div id="controlPanel">
                <button class="control-btn" onclick="togglePlayPause()" aria-label="Play or pause stream"><i class="fas fa-play"></i></button>
                <button class="control-btn" onclick="toggleQuality()" aria-label="Toggle stream quality"><i class="fas fa-cog"></i></button>
                <button class="control-btn" onclick="adjustVolume(0.1)" aria-label="Increase volume"><i class="fas fa-volume-up"></i></button>
                <button class="control-btn" onclick="adjustVolume(-0.1)" aria-label="Decrease volume"><i class="fas fa-volume-down"></i></button>
            </div>
            <button id="fullscreenBtn" onclick="toggleFullscreen()" aria-label="Toggle fullscreen"><i class="fas fa-expand"></i></button>
        </div>
    </div>
    <div id="loadingSpinner"></div>
    <div id="settingsModal">
        <div class="modal-content">
            <h2>Settings</h2>
            <label for="modalTimezoneSelect">Time Zone</label>
            <select id="modalTimezoneSelect">
                <option value="UTC">UTC</option>
                <option value="America/New_York">America/New York</option>
                <option value="Europe/London">Europe/London</option>
                <option value="Asia/Tokyo">Asia/Tokyo</option>
                <option value="Australia/Sydney">Australia/Sydney</option>
            </select>
            <label for="modalRegionSelect">Region</label>
            <select id="modalRegionSelect">
                <option value="global">Global</option>
                <option value="us">United States</option>
                <option value="uk">United Kingdom</option>
                <option value="eu">Europe</option>
                <option value="asia">Asia</option>
            </select>
            <label for="notificationsEnabled">Enable Match Start Notifications</label>
            <input type="checkbox" id="notificationsEnabled">
            <label for="animationsEnabled">Enable Animations</label>
            <input type="checkbox" id="animationsEnabled" checked>
            <button onclick="saveSettings()">Save</button>
        </div>
    </div>
    <footer>
        &copy; 2025 Football Live Streams. All rights reserved.
    </footer>
    <script>
        let matches = [];
        let currentMatchIndex = 0;
        let currentStreamIndex = 0;
        let currentPage = 'schedule';
        let timerInterval = null;
        let streamLoadTimeout = null;
        let streamCheckInterval = null;
        let isStreamPlaying = false;
        let isPaused = false;
        let currentQuality = 'hd';
        let timezone = localStorage.getItem('timezone') || 'UTC';
        let region = localStorage.getItem('region') || 'global';
        let notificationsEnabled = JSON.parse(localStorage.getItem('notificationsEnabled') || 'false');
        let animationsEnabled = JSON.parse(localStorage.getItem('animationsEnabled') || 'true');
        const navTabs = document.getElementById('navTabs');
        const scheduleContainer = document.getElementById('scheduleContainer');
        const streamMatchTitle = document.getElementById('streamMatchTitle');
        const streamCount = document.getElementById('streamCount');
        const streamList = document.getElementById('streamList');
        const playerFrame = document.getElementById('playerFrame');
        const streamStatus = document.getElementById('streamStatus');
        const timerEl = document.getElementById('timer');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const themeToggle = document.getElementById('themeToggle');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const timezoneSelect = document.getElementById('timezoneSelect');
        const regionSelect = document.getElementById('regionSelect');
        const modalTimezoneSelect = document.getElementById('modalTimezoneSelect');
        const modalRegionSelect = document.getElementById('modalRegionSelect');
        const notificationsEnabledCheckbox = document.getElementById('notificationsEnabled');
        const animationsEnabledCheckbox = document.getElementById('animationsEnabled');
        const baseUrl = 'https://streamed.pk';
        const scheduleUrl = './matches.json'; // Path to static JSON file

        // Initialize settings
        timezoneSelect.value = timezone;
        regionSelect.value = region;
        notificationsEnabledCheckbox.checked = notificationsEnabled;
        animationsEnabledCheckbox.checked = animationsEnabled;
        document.body.classList.toggle('no-animations', !animationsEnabled);

        // Theme toggle
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-mode');
            themeToggle.innerHTML = document.body.classList.contains('light-mode') ? '<i class="fas fa-sun"></i> Light Mode' : '<i class="fas fa-moon"></i> Dark Mode';
        });

        // Settings modal
        settingsBtn.addEventListener('click', () => {
            modalTimezoneSelect.value = timezone;
            modalRegionSelect.value = region;
            settingsModal.style.display = 'flex';
        });

        settingsModal.addEventListener('click', (e) => {
            if (e.target === settingsModal) settingsModal.style.display = 'none';
        });

        function saveSettings() {
            timezone = modalTimezoneSelect.value;
            region = modalRegionSelect.value;
            notificationsEnabled = notificationsEnabledCheckbox.checked;
            animationsEnabled = animationsEnabledCheckbox.checked;
            localStorage.setItem('timezone', timezone);
            localStorage.setItem('region', region);
            localStorage.setItem('notificationsEnabled', notificationsEnabled);
            localStorage.setItem('animationsEnabled', animationsEnabled);
            timezoneSelect.value = timezone;
            regionSelect.value = region;
            document.body.classList.toggle('no-animations', !animationsEnabled);
            fetchMatches();
            renderSchedule('all');
            settingsModal.style.display = 'none';
            if (notificationsEnabled) requestNotificationPermission();
        }

        // Page navigation
        navTabs.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                currentPage = tab.dataset.page;
                updatePage();
            });
        });

        function updatePage() {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.toggle('active', page.id === currentPage);
            });
            navTabs.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.page === currentPage);
            });
            if (currentPage === 'schedule') {
                renderSchedule('all');
                clearTimers();
                resetStreamStatus();
            } else if (currentPage === 'streams') {
                renderStreams();
                clearTimers();
                resetStreamStatus();
            } else if (currentPage === 'match') {
                loadStream();
                startMatchTimer();
                startStreamCheck();
            }
        }

        function clearTimers() {
            if (timerInterval) clearInterval(timerInterval);
            if (streamCheckInterval) clearInterval(streamCheckInterval);
            if (streamLoadTimeout) clearTimeout(streamLoadTimeout);
        }

        function resetStreamStatus() {
            streamStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Stream may experience interruptions';
            streamStatus.className = 'warning';
            isStreamPlaying = false;
        }

        // Notification permission
        function requestNotificationPermission() {
            if (Notification.permission !== 'granted') {
                Notification.requestPermission();
            }
        }

        // Fetch matches from static JSON file
        async function fetchMatches() {
            showLoading(true);
            try {
                const response = await fetch(scheduleUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                matches = data
                    .filter(m => m.category === 'football' || !m.category) // Backward compatibility
                    .map(m => ({
                        name: m.name,
                        startTime: new Date(m.startTime),
                        sources: m.sources,
                        teams: m.teams || { home: { name: 'Team A', badge: 'placeholder' }, away: { name: 'Team B', badge: 'placeholder' } }
                    }));
                matches.sort((a, b) => a.startTime - b.startTime);
                renderSchedule('all');
                if (notificationsEnabled) scheduleNotifications();
            } catch (error) {
                console.error('Error fetching matches:', error);
                scheduleContainer.innerHTML = `
                    <div class="error-message">
                        Unable to load schedule. Please try again later.
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }

        // Schedule notifications
        function scheduleNotifications() {
            matches.forEach(match => {
                const now = new Date();
                const timeUntilMatch = match.startTime - now - 10 * 60 * 1000; // 10 minutes before
                if (timeUntilMatch > 0 && timeUntilMatch < 24 * 60 * 60 * 1000) { // Within 24 hours
                    setTimeout(() => {
                        if (Notification.permission === 'granted') {
                            new Notification(`Match Alert: ${match.name}`, {
                                body: `Starting in 10 minutes!`,
                                icon: `${baseUrl}/api/images/proxy/${match.teams.home.badge}.webp`
                            });
                        }
                    }, timeUntilMatch);
                }
            });
        }

        function updateTimezone() {
            timezone = timezoneSelect.value;
            localStorage.setItem('timezone', timezone);
            renderSchedule('all');
            if (currentPage === 'match') startMatchTimer();
        }

        // Render schedule with sections for each day
        function renderSchedule(filterStatus = 'all', searchQuery = '') {
            scheduleContainer.innerHTML = '';
            const now = new Date();
            const fourHoursInMs = 4 * 60 * 60 * 1000;
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: timezone,
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                hour12: true
            });

            // Group matches by date
            const days = {};
            matches.forEach((match, index) => {
                const matchTime = new Date(match.startTime.toLocaleString('en-US', { timeZone: timezone }));
                const elapsed = Math.floor((now - match.startTime) / 1000);
                let status = 'finished';
                let timeText = 'Finished';
                if (elapsed < 0) {
                    status = 'upcoming';
                    timeText = `Starts in ${formatTime(Math.abs(elapsed))}`;
                } else if (elapsed < 120 * 60) {
                    status = 'live';
                    timeText = `Live for ${formatTime(elapsed)}`;
                }
                const matchEndTime = new Date(match.startTime.getTime() + 110 * 60 * 1000);
                const matchesFilter = filterStatus === 'all' || status === filterStatus;
                const matchesSearch = !searchQuery || match.name.toLowerCase().includes(searchQuery.toLowerCase());
                const isPrimeTime = matchTime.getHours() >= 18 && matchTime.getHours() <= 22;
                if (now - matchEndTime <= fourHoursInMs && matchesFilter && matchesSearch) {
                    const dateKey = formatter.format(matchTime).split(', ').slice(0, 3).join(', ');
                    if (!days[dateKey]) {
                        days[dateKey] = [];
                    }
                    days[dateKey].push({ match, index, status, timeText, isPrimeTime });
                }
            });

            // Render matches by day
            for (const date in days) {
                const section = document.createElement('div');
                section.className = 'day-section';
                section.innerHTML = `<h2 class="day-title">${date}</h2>`;
                const grid = document.createElement('div');
                grid.className = 'schedule-grid';

                days[date].forEach(({ match, index, status, timeText, isPrimeTime }) => {
                    const matchTime = new Date(match.startTime.toLocaleString('en-US', { timeZone: timezone }));
                    const timeString = formatter.format(matchTime);
                    const item = document.createElement('div');
                    item.className = `schedule-item ${status} ${isPrimeTime ? 'prime-time' : ''}`;
                    let teamsHtml = '';
                    if (match.teams.home && match.teams.away) {
                        teamsHtml = `
                            <div class="teams-row">
                                <div class="team">
                                    <img src="${baseUrl}/api/images/proxy/${match.teams.home.badge}.webp" alt="${match.teams.home.name}" class="team-badge">
                                    <span>${match.teams.home.name}</span>
                                </div>
                                <span class="vs">vs</span>
                                <div class="team">
                                    <img src="${baseUrl}/api/images/proxy/${match.teams.away.badge}.webp" alt="${match.teams.away.name}" class="team-badge">
                                    <span>${match.teams.away.name}</span>
                                </div>
                            </div>
                        `;
                    } else {
                        teamsHtml = `<p>Teams: ${match.teams.join(' vs ')}</p>`;
                    }
                    item.innerHTML = `
                        <div class="match-details">
                            <h3>${match.name}</h3>
                            ${teamsHtml}
                            <p>Time: ${timeText} (${timeString})</p>
                            <span class="match-status ${status}">${status.charAt(0).toUpperCase() + status.slice(1)}</span>
                        </div>
                    `;
                    item.onclick = () => {
                        currentMatchIndex = index;
                        currentStreamIndex = 0;
                        currentPage = 'streams';
                        updatePage();
                    };
                    grid.appendChild(item);
                });
                section.appendChild(grid);
                scheduleContainer.appendChild(section);
            }

            if (scheduleContainer.innerHTML === '') {
                scheduleContainer.innerHTML = '<div style="text-align:center; color:var(--text-medium);">No matches found.</div>';
            }
        }

        function sortByTime() {
            matches.sort((a, b) => a.startTime - b.startTime);
            renderSchedule('all', document.querySelector('#searchInput')?.value || '');
        }

        function filterByStatus(status) {
            renderSchedule(status, document.querySelector('#searchInput')?.value || '');
        }

        function searchMatches() {
            const query = document.getElementById('searchInput').value;
            renderSchedule('all', query);
        }

        // Render streams (still uses API for streams)
        async function renderStreams() {
            const match = matches[currentMatchIndex];
            streamMatchTitle.textContent = match.name;
            streamList.innerHTML = '<div style="text-align:center; color:var(--text-medium);">Loading streams...</div>';
            try {
                const allStreamsArrays = await Promise.all(match.sources.map(async source => {
                    try {
                        const response = await fetch(`${baseUrl}/api/stream/${source.source}/${source.id}`);
                        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                        return await response.json();
                    } catch {
                        return [];
                    }
                }));
                const allStreams = allStreamsArrays.flat().slice(1);
                match.streams = allStreams;
                streamCount.innerHTML = `Available Streams: ${allStreams.length}`;
                streamList.innerHTML = '';
                if (allStreams.length === 0) {
                    streamList.innerHTML = '<div style="text-align:center; color:var(--accent-red);">No streams available for this match.</div>';
                    return;
                }
                allStreams.forEach((s, index) => {
                    const isHD = 'hd' in s ? s.hd : (index === 0);
                    const qualityLabel = isHD ? 'HD' : 'SD';
                    const item = document.createElement('div');
                    item.className = 'stream-item';
                    item.innerHTML = `
                        <i class="fas fa-play-circle"></i> Stream ${index + 1}
                        <span class="stream-quality ${isHD ? 'hd' : 'sd'}">${qualityLabel}</span>
                    `;
                    item.onclick = () => {
                        currentStreamIndex = index;
                        currentPage = 'match';
                        updatePage();
                    };
                    streamList.appendChild(item);
                });
            } catch (error) {
                console.error('Error fetching streams:', error);
                streamList.innerHTML = '<div style="text-align:center; color:var(--accent-red);">Error loading streams. Please try again later.</div>';
            }
        }

        // Load stream
        function loadStream() {
            const match = matches[currentMatchIndex];
            if (!match.streams || currentStreamIndex >= match.streams.length) {
                streamStatus.innerHTML = '<i class="fas fa-times-circle"></i> No more streams available';
                streamStatus.className = 'status-frozen';
                return;
            }
            playerFrame.src = match.streams[currentStreamIndex].embedUrl;
            streamStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading stream...';
            streamStatus.className = 'status-loading';
            isStreamPlaying = false;
            clearTimeout(streamLoadTimeout);
            streamLoadTimeout = setTimeout(() => {
                if (!isStreamPlaying) {
                    streamStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Stream failed to load, trying next...';
                    streamStatus.className = 'status-frozen';
                    currentStreamIndex = (currentStreamIndex + 1) % match.streams.length;
                    loadStream();
                }
            }, 10000);

            playerFrame.addEventListener('load', () => {
                isStreamPlaying = true;
                streamStatus.innerHTML = '<i class="fas fa-check-circle"></i> Stream active';
                streamStatus.className = 'status-active';
                clearTimeout(streamLoadTimeout);
            }, { once: true });

            playerFrame.addEventListener('error', () => {
                isStreamPlaying = false;
                streamStatus.innerHTML = '<i class="fas fa-exclamation-circle"></i> Stream failed to load, trying next...';
                streamStatus.className = 'status-frozen';
                currentStreamIndex = (currentStreamIndex + 1) % match.streams.length;
                loadStream();
            }, { once: true });
        }

        // Stream check
        function startStreamCheck() {
            clearInterval(streamCheckInterval);
            streamCheckInterval = setInterval(() => {
                if (currentPage !== 'match') return;
                if (isStreamPlaying) {
                    streamStatus.innerHTML = '<i class="fas fa-check-circle"></i> Stream active';
                    streamStatus.className = 'status-active';
                } else {
                    streamStatus.innerHTML = '<i class="fas fa-pause-circle"></i> Stream not playing';
                    streamStatus.className = 'status-not-playing';
                }
            }, 5000);
        }

        // Match timer
        function startMatchTimer() {
            clearInterval(timerInterval);
            const match = matches[currentMatchIndex];
            const startTime = new Date(match.startTime.toLocaleString('en-US', { timeZone: timezone }));
            const formatter = new Intl.DateTimeFormat('en-US', {
                timeZone: timezone,
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
                hour12: true
            });
            timerInterval = setInterval(() => {
                const currentTime = new Date();
                let elapsed = Math.floor((currentTime - match.startTime) / 1000);
                let displayText = "";
                if (elapsed < 0) {
                    displayText = `<i class="fas fa-hourglass-start"></i> Starts In: ${formatTime(Math.abs(elapsed))} (${formatter.format(match.startTime)})`;
                } else if (elapsed < 45 * 60) {
                    displayText = `<i class="fas fa-clock"></i> ${formatTime(elapsed)} (1st Half)`;
                } else if (elapsed < 50 * 60) {
                    displayText = `<i class="fas fa-clock"></i> ${formatTime(elapsed - 45 * 60)} (1st Half +)`;
                } else if (elapsed < 60 * 60) {
                    displayText = `<i class="fas fa-pause"></i> Halftime: ${formatTime(elapsed - 50 * 60)}`;
                } else if (elapsed < 105 * 60) {
                    displayText = `<i class="fas fa-clock"></i> ${formatTime(elapsed - 60 * 60)} (2nd Half)`;
                } else if (elapsed < 110 * 60) {
                    displayText = `<i class="fas fa-clock"></i> ${formatTime(elapsed - 105 * 60)} (2nd Half +)`;
                } else {
                    displayText = `<i class="fas fa-flag-checkered"></i> Full Time`;
                    clearInterval(timerInterval);
                }
                timerEl.innerHTML = displayText;
            }, 1000);
        }

        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            if (hours > 0) {
                return `${hours}h ${minutes}m`;
            }
            return `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
        }

        function toggleFullscreen() {
            const container = document.getElementById('playerContainer');
            if (!document.fullscreenElement) {
                container.requestFullscreen().catch(err => console.error('Fullscreen error:', err));
            } else {
                document.exitFullscreen();
            }
        }

        function togglePlayPause() {
            isPaused = !isPaused;
            const playBtn = document.querySelector('#controlPanel .control-btn i.fa-play, #controlPanel .control-btn i.fa-pause');
            playBtn.className = isPaused ? 'fas fa-play' : 'fas fa-pause';
            console.log(isPaused ? 'Pause stream' : 'Play stream');
        }

        function toggleQuality() {
            currentQuality = currentQuality === 'hd' ? 'sd' : 'hd';
            console.log(`Switched to ${currentQuality.toUpperCase()} quality`);
            loadStream();
        }

        function adjustVolume(change) {
            console.log(`Volume adjusted by ${change}`);
        }

        function showLoading(show) {
            loadingSpinner.style.display = show ? 'block' : 'none';
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            switch (e.key.toLowerCase()) {
                case 's':
                    currentPage = 'schedule';
                    updatePage();
                    break;
                case 't':
                    currentPage = 'streams';
                    updatePage();
                    break;
                case 'm':
                    currentPage = 'match';
                    updatePage();
                    break;
                case 'f':
                    toggleFullscreen();
                    break;
                case 'p':
                    togglePlayPause();
                    break;
            }
        });

        // Initialize
        if (notificationsEnabled) requestNotificationPermission();
        fetchMatches();
        updatePage();
        setInterval(fetchMatches, 300000); // Auto-refresh every 5 minutes
    </script>
</body>
</html>
